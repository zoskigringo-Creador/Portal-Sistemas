<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Logístico M3 (v2)</title>

    <!-- 
      Bibliotecas externas necesarias para la funcionalidad.
    -->
    <!-- NUEVA: Para leer/escribir archivos Excel (SheetJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Para generar PDF (jsPDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Para generar tablas en PDF (jsPDF-AutoTable) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <!-- 
    =================================
    INICIO DEL CSS (Estilos)
    =================================
    -->
    <style>
        /* Estilos Generales */
        :root {
            --color-primario: #0056b3;
            --color-primario-hover: #004a99;
            --color-secundario: #007bff;
            --color-fondo: #f4f7f6;
            --color-tarjeta: #ffffff;
            --color-texto: #333;
            --color-error: #d9534f;
            --sombra-tarjeta: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        html {
            box-sizing: border-box;
        }
        *, *:before, *:after {
            box-sizing: inherit;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--color-fondo);
            color: var(--color-texto);
            margin: 0;
            padding: 10px; /* Un poco de padding para tablets */
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 1600px; /* Aumentado para más columnas */
            margin: 10px auto;
            padding: 20px;
            background-color: var(--color-tarjeta);
            border-radius: 10px;
            box-shadow: var(--sombra-tarjeta);
        }

        /* Encabezado y Títulos */
        header {
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
            padding-bottom: 10px;
        }

        .app-title {
            color: var(--color-primario);
            font-size: clamp(1.5rem, 5vw, 1.75rem); /* Tamaño de fuente adaptable */
            margin: 0;
            text-align: center;
        }

        #welcome-message {
            color: #555;
            font-size: clamp(1.1rem, 4vw, 1.25rem);
            font-weight: 500;
            text-align: center;
            margin: 10px 0 0 0;
        }

        /* Pantalla de Login */
        #login-container {
            max-width: 450px;
            text-align: center;
            margin-top: 40px;
        }

        #login-container h1 {
            color: var(--color-primario);
        }

        /* Controles (Carga, Filtro, Exportar) */
        .controls, .exports, .summary {
            display: flex;
            flex-direction: column; /* Apilado en móviles */
            gap: 20px;
            margin-bottom: 25px;
        }
        
        /* En pantallas más grandes, se ponen en fila */
        @media (min-width: 768px) {
            .controls, .exports, .summary {
                flex-direction: row;
                flex-wrap: wrap;
                align-items: flex-end;
            }
        }


        .control-group {
            display: flex;
            flex-direction: column;
            flex: 1; /* Ocupan espacio disponible */
            min-width: 200px;
        }

        label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #444;
        }

        input[type="file"], select, input[type="password"], input[type="number"] {
            padding: 12px 10px; /* Más alto para tocar fácil */
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px; /* Más grande para legibilidad */
            width: 100%; /* Ocupa todo el ancho del .control-group */
        }

        button {
            padding: 12px 15px; /* Botones más táctiles */
            border: none;
            border-radius: 5px;
            background-color: var(--color-secundario);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%; /* Ocupan todo el ancho en móvil */
        }
        
        @media (min-width: 768px) {
            button {
                width: auto; /* Ancho automático en pantallas grandes */
            }
        }


        button:hover {
            background-color: var(--color-primario-hover);
        }
        
        #login-button {
             background-color: var(--color-primario);
        }
        #login-button:hover {
             background-color: var(--color-primario-hover);
        }

        #export-pdf {
            background-color: var(--color-error);
        }
        #export-pdf:hover {
            background-color: #c9302c;
        }

        /* CAMBIO: Renombrado a export-excel */
        #export-excel {
             background-color: #28a745; /* Verde Excel */
        }
        #export-excel:hover {
            background-color: #218838;
        }


        #clear-data {
            background-color: #f0ad4e; /* Naranja */
        }
        #clear-data:hover {
            background-color: #ec971f;
        }

        .error-msg {
            color: var(--color-error);
            font-size: 14px;
            display: none; /* Oculto por defecto */
            margin-top: 10px;
        }

        /* Resumen */
        .summary {
            background-color: #fdfdfd;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
        }
        .summary p {
            margin: 0 10px 0 0;
            font-size: 16px;
            flex: 1;
            text-align: center;
        }
        .summary strong {
            color: var(--color-secundario);
            font-size: 1.25em;
            display: block; /* Muestra el número debajo del texto */
            margin-top: 5px;
        }

        /* Tabla de Datos */
        .data-table-container {
            width: 100%;
            overflow-x: auto; /* Permite scroll horizontal en la tabla (clave en tablets) */
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 10px 12px;
            text-align: left;
            vertical-align: middle;
            white-space: nowrap; /* Evita que el texto se rompa en varias líneas */
        }

        th {
            background-color: #f9f9f9;
            font-weight: 700;
            color: #333;
            position: sticky; /* Encabezado fijo al hacer scroll vertical */
            top: 0;
        }

        /* Inputs dentro de la tabla */
        td input[type="number"] {
            width: 90px; /* Ancho fijo para inputs de medidas */
            padding: 8px 5px;
            font-size: 15px;
        }

        /* Celdas calculadas */
        td.cell-m3, td.cell-m3-unidad, td.cell-peso-unidad {
            font-weight: 700;
            text-align: right;
        }

        td.cell-m3 {
            color: var(--color-primario);
            min-width: 110px;
            background-color: #f7faff;
        }
        /* NUEVO: Estilo para celdas de unidad */
        td.cell-m3-unidad, td.cell-peso-unidad {
             color: #444;
             background-color: #fdfdfd;
             min-width: 110px;
        }
        
        td.cell-desc {
            white-space: normal; /* Permite que la descripción se ajuste */
            min-width: 250px;
        }
        
        td:first-child, td:nth-child(3) {
             white-space: normal; /* Cod. Barra y Proveedor también se ajustan */
        }
        
        /* Mensaje de carga */
        .loading-message {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #777;
        }

    </style>
    <!-- 
    =================================
    FIN DEL CSS
    =================================
    -->
</head>
<body>

    <!-- 
    =================================
    INICIO DEL HTML (Estructura)
    =================================
    -->

    <!-- Pantalla de Inicio de Sesión -->
    <div id="login-container" class="container">
        <h1>Control Logístico</h1>
        <p>Por favor, ingresa tu código de indicador.</p>
        <div class="control-group">
            <input type="password" id="login-pin" placeholder="Código" inputmode="numeric">
        </div>
        <button id="login-button">Ingresar</button>
        <p id="login-error" class="error-msg"></p>
    </div>

    <!-- Pantalla Principal de la Aplicación (oculta al inicio) -->
    <main id="app-container" class="container" style="display:none;">
        <header>
            <h1 class="app-title">Llevando la logística al siguiente nivel</h1>
            <h2 id="welcome-message"></h2>
        </header>

        <!-- Sección de Carga y Filtros -->
        <section class="controls">
            <div class="control-group">
                <!-- CAMBIO: Acepta .xlsx y .xls en lugar de .csv -->
                <label for="file-input">1. Cargar archivo Excel (.xlsx):</label>
                <input type="file" id="file-input" accept=".xlsx, .xls">
            </div>
            
            <div class="control-group">
                <label for="provider-filter">2. Filtrar por Proveedor:</label>
                <select id="provider-filter">
                    <option value="todos">Mostrar Todos</option>
                </select>
            </div>
        </section>

        <!-- Sección de Reportes -->
        <section class="exports">
            <!-- CAMBIO: Botón renombrado a "Exportar a Excel" -->
            <button id="export-excel">Exportar a Excel (.xlsx)</button>
            <button id="export-pdf">Exportar a PDF</button>
            <button id="clear-data">Limpiar Datos Guardados</button>
        </section>

        <!-- Resumen de Métricos -->
        <section class="summary">
            <p>M3 Totales (Cajas): <strong id="total-m3">0.000</strong></p>
            <p>Peso Total (Cajas): <strong id="total-peso">0.000</strong></p>
        </section>

        <!-- Tabla de Datos -->
        <section class="data-table-container">
            <table id="data-table">
                <thead>
                    <tr>
                        <th>Cód. Barra</th>
                        <th>Descripción</th>
                        <th>Proveedor</th>
                        <!-- NUEVA COLUMNA -->
                        <th>Unidades (REL_UCP)</th>
                        <th>Largo (cm)</th>
                        <th>Ancho (cm)</th>
                        <th>Alto (cm)</th>
                        <th>Peso (kg)</th>
                        <th>M3 (Caja)</th>
                        <!-- NUEVAS COLUMNAS -->
                        <th>M3 x Und.</th>
                        <th>Peso x Und.</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Las filas se generarán con JavaScript -->
                </tbody>
            </table>
        </section>
    </main>

    <!-- 
    =================================
    FIN DEL HTML
    =================================
    -->


    <!-- 
    =================================
    INICIO DEL JAVASCRIPT (Lógica)
    =================================
    -->
    <script type="module">
        // Esperamos a que todo el HTML esté cargado
        document.addEventListener('DOMContentLoaded', () => {

            // Referencias a elementos del DOM (Login)
            const loginContainer = document.getElementById('login-container');
            const appContainer = document.getElementById('app-container');
            const loginButton = document.getElementById('login-button');
            const loginPinInput = document.getElementById('login-pin');
            const loginError = document.getElementById('login-error');
            const welcomeMessage = document.getElementById('welcome-message');

            // Referencias a elementos del DOM (App)
            // CAMBIO: ID del input de archivo
            const fileInput = document.getElementById('file-input');
            const providerFilter = document.getElementById('provider-filter');
            const tableBody = document.getElementById('table-body');
            const totalM3Display = document.getElementById('total-m3');
            const totalPesoDisplay = document.getElementById('total-peso');
            // CAMBIO: ID del botón de exportar
            const exportExcelButton = document.getElementById('export-excel');
            const exportPdfButton = document.getElementById('export-pdf');
            const clearDataButton = document.getElementById('clear-data');

            // --- ESTADO DE LA APLICACIÓN ---
            let appState = {
                estaLogueado: false,
                productos: [] // Aquí guardaremos los datos del Excel y las mediciones
            };

            const STORAGE_KEY = 'logisticaAppRodrigoData';

            // --- 1. LÓGICA DE LOGIN Y PERSISTENCIA ---

            function saveData() {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
                } catch (e) {
                    console.error("Error al guardar en LocalStorage:", e);
                    // No usamos alert() para no interrumpir al usuario
                }
            }

            function loadData() {
                const dataGuardada = localStorage.getItem(STORAGE_KEY);
                if (dataGuardada) {
                    appState = JSON.parse(dataGuardada);
                    
                    if (appState.estaLogueado) {
                        mostrarApp();
                        if (appState.productos && appState.productos.length > 0) {
                            actualizarFiltroProveedores();
                            renderizarTabla();
                        }
                    }
                }
            }

            loginButton.addEventListener('click', () => {
                const pin = loginPinInput.value;
                if (pin === '5') {
                    appState.estaLogueado = true;
                    saveData();
                    mostrarApp();
                } else {
                    loginError.textContent = 'Código incorrecto. Intenta de nuevo.';
                    loginError.style.display = 'block';
                    if (navigator.vibrate) navigator.vibrate(200);
                }
            });
            
             loginPinInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') loginButton.click();
            });

            function mostrarApp() {
                loginContainer.style.display = 'none';
                appContainer.style.display = 'block';
                welcomeMessage.textContent = 'Bienvenido, Rodrigo.';
            }

            // --- 2. LÓGICA DE CARGA DE ARCHIVO (Excel .xlsx) ---

            // CAMBIO: Event listener para el nuevo input
            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                // Mostramos un mensaje de carga (Colspan actualizado a 11)
                tableBody.innerHTML = `<tr><td colspan="11" class="loading-message">Leyendo archivo Excel...</td></tr>`;

                const reader = new FileReader();
                reader.readAsArrayBuffer(file);

                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        // Usamos la biblioteca XLSX (SheetJS)
                        const workbook = XLSX.read(data, {type: 'array'});
                        
                        // Leemos la primera hoja
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        
                        // Convertimos la hoja a JSON (array de objetos)
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);

                        if (!Array.isArray(jsonData) || jsonData.length === 0) {
                             throw new Error('El archivo Excel está vacío o no tiene un formato válido.');
                        }

                        // Función helper para leer propiedades con nombres variables
                        const getVal = (row, ...keys) => {
                            for (const key of keys) {
                                if (row[key] !== undefined && row[key] !== null) {
                                    return row[key];
                                }
                            }
                            return null;
                        };
                        
                        // Mapeamos los datos del Excel a nuestra estructura
                        appState.productos = jsonData.map(row => {
                            const producto = {
                                codBarra: getVal(row, 'COD_BARRA') || 'N/A',
                                descripcion: getVal(row, 'XDESC') || 'Sin descripción',
                                proveedor: getVal(row, 'PROVEEDOR', 'PROVEEDOR ') || 'N/A',
                                // NUEVO: Leemos REL_UCP. Si no existe o es 0, default a 1.
                                relUcp: parseFloat(getVal(row, 'REL_UCP')) || 1, 
                                largo: parseFloat(getVal(row, 'LARGO', 'LARGO ')) || 0,
                                ancho: parseFloat(getVal(row, 'ANCHO')) || 0,
                                alto: parseFloat(getVal(row, 'ALTO', 'ALTURA')) || 0,
                                peso: parseFloat(getVal(row, 'PESO')) || 0,
                                m3: 0,
                                // NUEVO: Campos para cálculo unitario
                                m3PorUnidad: 0,
                                pesoPorUnidad: 0
                            };
                            
                            // Si el producto es inválido (ej. fila vacía), lo filtramos luego
                            if (producto.codBarra === 'N/A' && producto.descripcion === 'Sin descripción') {
                                return null;
                            }
                            
                            return producto;
                        }).filter(Boolean); // Filtramos productos nulos
                        
                        // Calculamos M3 y valores unitarios para los datos que ya venían en el Excel
                        appState.productos.forEach(calcularValores);

                        actualizarFiltroProveedores();
                        renderizarTabla();
                        saveData(); // Guardamos los productos cargados

                    } catch (err) {
                        console.error(err);
                        alert('Error al leer el archivo Excel: ' + err.message);
                        tableBody.innerHTML = `<tr><td colspan="11" class="loading-message">Error al cargar. Intenta de nuevo.</td></tr>`;
                    }
                };

                reader.onerror = () => {
                     alert('Error al leer el archivo.');
                     tableBody.innerHTML = `<tr><td colspan="11" class="loading-message">Error al leer.</td></tr>`;
                };
            });

            // --- 3. LÓGICA DE FILTRADO Y RENDERIZADO DE TABLA ---

            function actualizarFiltroProveedores() {
                const proveedores = [...new Set(appState.productos.map(p => p.proveedor))]
                                     .filter(p => p && p !== 'N/A')
                                     .sort();
        
                providerFilter.innerHTML = '<option value="todos">Mostrar Todos</option>';
                
                proveedores.forEach(prov => {
                    const option = document.createElement('option');
                    option.value = prov;
                    option.textContent = prov;
                    providerFilter.appendChild(option);
                });
            }

            providerFilter.addEventListener('change', renderizarTabla);

            function renderizarTabla() {
                tableBody.innerHTML = '';
                
                if (!appState.productos || appState.productos.length === 0) {
                     tableBody.innerHTML = `<tr><td colspan="11" class="loading-message">Carga un archivo Excel para comenzar.</td></tr>`;
                     actualizarTotales();
                     return;
                }
                
                const provSeleccionado = providerFilter.value;
                const productosFiltrados = appState.productos.filter(p => {
                    return provSeleccionado === 'todos' || p.proveedor === provSeleccionado;
                });

                if (productosFiltrados.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="11" class="loading-message">No hay productos para el proveedor seleccionado.</td></tr>`;
                }

                // CAMBIO: HTML de la fila actualizado con las nuevas columnas
                productosFiltrados.forEach(producto => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-id', producto.codBarra); 

                    row.innerHTML = `
                        <td>${producto.codBarra}</td>
                        <td class="cell-desc">${producto.descripcion}</td>
                        <td>${producto.proveedor}</td>
                        <td>${producto.relUcp}</td> 
                        <td><input type="number" class="input-medida" data-field="largo" value="${producto.largo || ''}" inputmode="decimal"></td>
                        <td><input type="number" class="input-medida" data-field="ancho" value="${producto.ancho || ''}" inputmode="decimal"></td>
                        <td><input type="number" class="input-medida" data-field="alto" value="${producto.alto || ''}" inputmode="decimal"></td>
                        <td><input type="number" class="input-medida" data-field="peso" value="${producto.peso || ''}" inputmode="decimal"></td>
                        <td class="cell-m3">${producto.m3.toFixed(6)}</td>
                        <td class="cell-m3-unidad">${producto.m3PorUnidad.toFixed(8)}</td>
                        <td class="cell-peso-unidad">${producto.pesoPorUnidad.toFixed(4)}</td>
                    `;
                    tableBody.appendChild(row);
                });
                
                actualizarTotales();
            }

            // --- 4. LÓGICA DE CÁLCULO EN TIEMPO REAL ---
            
            // CAMBIO: Esta función ahora calcula M3 y también los valores unitarios
            function calcularValores(producto) {
                // 1. Calcular M3 de la caja
                if (producto.largo > 0 && producto.ancho > 0 && producto.alto > 0) {
                    // (Largo * Ancho * Alto) / 1,000,000 para pasar de cm³ a m³
                    producto.m3 = (producto.largo * producto.ancho * producto.alto) / 1000000;
                } else {
                    producto.m3 = 0;
                }
                
                // 2. Asegurar que relUcp (unidades) sea un número válido (mínimo 1)
                const unidades = (producto.relUcp > 0) ? producto.relUcp : 1;
                
                // 3. Calcular valores unitarios
                producto.m3PorUnidad = producto.m3 / unidades;
                producto.pesoPorUnidad = producto.peso / unidades;
            }

            tableBody.addEventListener('input', (event) => {
                if (event.target.classList.contains('input-medida')) {
                    
                    const input = event.target;
                    const row = input.closest('tr');
                    const codBarra = row.getAttribute('data-id');
                    const field = input.getAttribute('data-field'); // largo, ancho, alto, peso
                    const valor = parseFloat(input.value) || 0;

                    const producto = appState.productos.find(p => p.codBarra === codBarra);
                    if (!producto) return;

                    // Actualizamos el valor en el estado
                    producto[field] = valor;

                    // Recalculamos M3 y valores unitarios
                    calcularValores(producto);

                    // Actualizamos todas las celdas calculadas en la tabla en tiempo real
                    row.querySelector('.cell-m3').textContent = producto.m3.toFixed(6);
                    row.querySelector('.cell-m3-unidad').textContent = producto.m3PorUnidad.toFixed(8);
                    row.querySelector('.cell-peso-unidad').textContent = producto.pesoPorUnidad.toFixed(4);
                    
                    actualizarTotales();
                    saveData();
                }
            });

            function actualizarTotales() {
                if (!appState.productos) {
                    totalM3Display.textContent = "0.000";
                    totalPesoDisplay.textContent = "0.000";
                    return;
                }
                
                let totalM3 = 0;
                let totalPeso = 0;

                appState.productos.forEach(p => {
                    totalM3 += p.m3 || 0;
                    totalPeso += p.peso || 0;
                });

                totalM3Display.textContent = totalM3.toFixed(6);
                totalPesoDisplay.textContent = totalPeso.toFixed(3);
            }

            // --- 5. LÓGICA DE EXPORTACIÓN ---

            // CAMBIO: Exportar a .xlsx usando SheetJS
            exportExcelButton.addEventListener('click', () => {
                if (!appState.productos || appState.productos.length === 0) {
                    alert("No hay datos para exportar.");
                    return;
                }
                
                // --- INICIO DE LA MODIFICACIÓN ---
                // 1. Filtramos los productos según el proveedor seleccionado
                const provSeleccionado = providerFilter.value;
                const productosFiltrados = appState.productos.filter(p => {
                    return provSeleccionado === 'todos' || p.proveedor === provSeleccionado;
                });

                if (productosFiltrados.length === 0) {
                    alert("No hay productos para exportar para el proveedor seleccionado.");
                    return;
                }

                // 2. Preparamos los datos filtrados con cabeceras en español
                const dataToExport = productosFiltrados.map(p => ({
                // --- FIN DE LA MODIFICACIÓN (la variable appState.productos se cambió por productosFiltrados) ---
                    "Código Barra": p.codBarra,
                    "Descripción": p.descripcion,
                    "Proveedor": p.proveedor,
                    "Unidades (REL_UCP)": p.relUcp,
                    "Largo (cm)": p.largo,
                    "Ancho (cm)": p.ancho,
                    "Alto (cm)": p.alto,
                    "Peso (kg)": p.peso,
                    "M3 Caja": p.m3,
                    "M3 Unidad": p.m3PorUnidad,
                    "Peso Unidad": p.pesoPorUnidad
                }));

                // 3. Creamos una hoja de cálculo (worksheet) desde nuestro JSON
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                
                // 4. Creamos un nuevo libro de trabajo (workbook)
                const workbook = XLSX.utils.book_new();
                
                // 5. Añadimos la hoja al libro
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Mediciones');

                // 6. Escribimos (descargamos) el archivo .xlsx
                // Hacemos que el nombre del archivo incluya el proveedor (si está filtrado)
                // const provSeleccionado = providerFilter.value; // Esta línea ya estaba arriba
                let fileName = 'reporte_mediciones_total.xlsx';
                if (provSeleccionado !== 'todos') {
                    fileName = `reporte_mediciones_${provSeleccionado.replace(/ /g, '_')}.xlsx`; // Reemplaza espacios por si acaso
                }
                
                XLSX.writeFile(workbook, fileName);
            });

            // CAMBIO: Exportar a PDF actualizado
            exportPdfButton.addEventListener('click', () => {
                if (!appState.productos || appState.productos.length === 0) {
                    alert("No hay datos para exportar.");
                    return;
                }

                const { jsPDF } = window.jspdf;
                // CAMBIO: 'l' para landscape (apaisado/horizontal)
                const doc = new jsPDF('l', 'mm', 'a4'); 

                doc.setFontSize(18);
                doc.text("Reporte de Mediciones Logísticas", 14, 20);
                
                doc.setFontSize(12);
                doc.text(`Proveedor: ${providerFilter.options[providerFilter.selectedIndex].text}`, 14, 28);
                doc.text(`M3 Totales (Cajas): ${totalM3Display.textContent}`, 14, 34);
                doc.text(`Peso Total (Cajas): ${totalPesoDisplay.textContent} kg`, 100, 34);

                // CAMBIO: Cabeceras actualizadas
                const head = [['Cód. Barra', 'Descripción', 'Prov.', 'Und.', 'L(cm)', 'A(cm)', 'H(cm)', 'Peso(kg)', 'M3 Caja', 'M3 Und.', 'Peso Und.']];
                
                const provSeleccionado = providerFilter.value;
                // Esta lógica de filtrado ya era correcta y tomaba el proveedor seleccionado
                const productosFiltrados = appState.productos.filter(p => {
                    return provSeleccionado === 'todos' || p.proveedor === provSeleccionado;
                });
                
                if (productosFiltrados.length === 0) {
                    alert("No hay productos para exportar para el proveedor seleccionado.");
                    return;
                }

                // CAMBIO: Body actualizado
                const body = productosFiltrados.map(p => [
                    p.codBarra,
                    p.descripcion.substring(0, 35), // Descripción un poco más larga
                    p.proveedor.substring(0, 15), // Acortamos proveedor
                    p.relUcp,
                    p.largo,
                    p.ancho,
                    p.alto,
                    p.peso,
                    p.m3.toFixed(6),
                    p.m3PorUnidad.toFixed(8),
                    p.pesoPorUnidad.toFixed(4)
                ]);

                doc.autoTable({
                    startY: 40,
                    head: head,
                    body: body,
                    theme: 'grid',
                    headStyles: { fillColor: [0, 91, 179] }, // Azul
                    // CAMBIO: Estilos ajustados para landscape
                    styles: { fontSize: 7, cellPadding: 1.5 }, 
                    columnStyles: {
                        0: { cellWidth: 25 }, // Cod. Barra
                        1: { cellWidth: 60 }, // Descripción
                        2: { cellWidth: 25 }, // Prov
                        3: { cellWidth: 10, halign: 'right' }, // Und
                        4: { cellWidth: 12, halign: 'right' }, // L
                        5: { cellWidth: 12, halign: 'right' }, // A
                        6: { cellWidth: 12, halign: 'right' }, // H
                        7: { cellWidth: 15, halign: 'right' }, // Peso
                        8: { cellWidth: 20, halign: 'right' }, // M3 Caja
                        9: { cellWidth: 22, halign: 'right' }, // M3 Und
                        10: { cellWidth: 20, halign: 'right' } // Peso Und
                    }
                });

                doc.save('reporte_mediciones.pdf');
            });

            // --- 6. UTILIDADES ---

            clearDataButton.addEventListener('click', () => {
                if (confirm("¿Estás seguro de que deseas borrar todos los datos guardados? Esta acción no se puede deshacer.")) {
                    localStorage.removeItem(STORAGE_KEY);
                    appState = { estaLogueado: false, productos: [] };
                    window.location.reload();
                }
            });

            window.addEventListener('beforeunload', (event) => {
                if (appState.productos && appState.productos.length > 0) {
                    event.preventDefault();
                    event.returnValue = '¿Estás seguro de que quieres salir? Los cambios no guardados se perderán.'; 
                    return '¿Estás seguro de que quieres salir? Los cambios no guardados se perderán.';
                }
            });
            
            // --- INICIALIZACIÓN ---
            loadData(); 

        }); // Fin del DOMContentLoaded
    </script>
    <!-- 
    =================================
    FIN DEL JAVASCRIPT
    =================================
    -->

</body>
</html>

